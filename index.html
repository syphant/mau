<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <link rel="dns-prefetch" href="//www.nerdfonts.com" />
    <link rel="preconnect" href="https://www.nerdfonts.com" crossorigin />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preload" href="./styles.css" as="style" />
    <link rel="stylesheet" href="https://www.nerdfonts.com/assets/css/webfont.css" />
    <link rel="stylesheet" type="text/css" href="./styles.css" />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    
    <!-- Allow React to run buildless via "text/babel" script -->
    <script
      src="https://unpkg.com/@babel/standalone@7.25.6/babel.min.js"
      integrity="sha256-aS0B0wnsaDByLfE16h4MDCP1fQFccysd1YWOcV+gbBo="
      crossorigin="anonymous">
    </script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, {
        useState,
        useEffect,
      } from 'https://esm.sh/react@18?dev';
      import { createRoot } from 'https://esm.sh/react-dom@18/client?dev';
      import * as zebar from 'https://esm.sh/zebar@3.0';

      const providers = zebar.createProviderGroup({
        glazewm: { type: 'glazewm' },
        cpu: { type: 'cpu' },
        date: { type: 'date', formatting: 'EEE M/d/yyyy' },
        time: { type: 'date', formatting: 'h:mm:ss a' },
        battery: { type: 'battery' },
        memory: { type: 'memory' },
        audio: { type: 'audio' },
        weather: { type: 'weather' },
        media: { type: 'media' },
        systray: { type: 'systray' },
      });

      createRoot(document.getElementById('root')).render(<App />);

      function App() {
        const [output, setOutput] = useState(providers.outputMap);
        const [useFahrenheit, setUseFahrenheit] = useState(true);
        const [isTransitioning, setIsTransitioning] = useState(false);
        const [previousVolume, setPreviousVolume] = useState(50);
        const mediaTitleRef = React.useRef(null);

        useEffect(() => {
          providers.onOutput(() => setOutput(providers.outputMap));
        }, []);

        useEffect(() => {
          const titleElement = mediaTitleRef.current;
          if (titleElement) {
            const containerWidth = 300;
            const textWidth = titleElement.scrollWidth;
            
            if (textWidth > containerWidth) {
              const scrollDistance = textWidth - containerWidth;
              const baseRate = 20; // pixels per second
              const scrollDuration = (scrollDistance / baseRate) * 2; // for back-and-forth
              const pauseDuration = 2; // Pause at each end
              const totalDuration = scrollDuration + pauseDuration;
              
              titleElement.style.setProperty('--scroll-duration', `${totalDuration}s`);
              titleElement.classList.add('scrolling');
            } else {
              titleElement.classList.remove('scrolling');
            }
          }
        }, [output.media?.currentSession?.title, output.media?.currentSession?.artist]);

        // Get icon to reflect how much of the battery is charged.
        function getBatteryIcon(batteryOutput) {
          if (batteryOutput.chargePercent > 90)
            return <i className="nf nf-fa-battery_4"></i>;
          if (batteryOutput.chargePercent > 70)
            return <i className="nf nf-fa-battery_3"></i>;
          if (batteryOutput.chargePercent > 40)
            return <i className="nf nf-fa-battery_2"></i>;
          if (batteryOutput.chargePercent > 20)
            return <i className="nf nf-fa-battery_1"></i>;
          return <i className="nf nf-fa-battery_0"></i>;
        }

        // Get icon to reflect current weather status
        function getWeatherIcon(weatherOutput) {
          switch (weatherOutput.status) {
            case 'clear_day':
              return <i className="nf nf-md-weather_sunny"></i>;
            case 'clear_night':
              return <i className="nf nf-oct-moon"></i>;
            case 'cloudy_day':
              return <i className="nf nf-md-weather_cloudy"></i>;
            case 'cloudy_night':
              return <i className="nf nf-md-weather_night_partly_cloudy"></i>;
            case 'light_rain_day':
            case 'light_rain_night':
              return <i className="nf nf-md-weather_rainy"></i>;
            case 'heavy_rain_day':
            case 'heavy_rain_night':
              return <i className="nf nf-md-weather_pouring"></i>;
            case 'snow_day':
            case 'snow_night':
              return <i className="nf nf-md-weather_snowy_heavy"></i>;
            case 'thunder_day':
            case 'thunder_night':
              return <i className="nf nf-md-weather_lightning"></i>;
            default:
              return <i className="nf nf-md-weather_sunny"></i>;
          }
        }

        // Convert temperature between Fahrenheit and Celsius
        function getDisplayedTemperature(weatherOutput) {
          if (useFahrenheit) {
            return {
              temp: Math.round(weatherOutput.fahrenheitTemp),
              unit: '°F'
            };
          } else {
            return {
              temp: Math.round(weatherOutput.celsiusTemp),
              unit: '°C'
            };
          }
        }
        
        // Handle toggling between Fahrenheit and Celsius
        function toggleTemperatureUnit() {
          if (isTransitioning) return;
          
          setIsTransitioning(true);
          
          // Start fade out
          setTimeout(() => {
            setUseFahrenheit(!useFahrenheit);
            
            // Fade back in
            setTimeout(() => {
              setIsTransitioning(false);
            }, 100);
          }, 100);
        }

        // Get icon to reflect current volume level
        function getVolumeIcon(audioOutput) {
          if (!audioOutput.defaultPlaybackDevice) return <i className="nf nf-md-volume_xmark"></i>;
          
          const device = audioOutput.defaultPlaybackDevice;
          const volumePercent = device.volume; // Already 0-100 according to docs
          
          // Check for various possible muted state properties
          const isMuted = device.isMuted === true || 
                          device.muted === true || 
                          device.isSilenced === true ||
                          volumePercent === 0;
          
          if (isMuted) {
            return <i className="nf nf-md-volume_off"></i>;
          } else if (volumePercent >= 1 && volumePercent <= 33) {
            return <i className="nf nf-md-volume_low"></i>;
          } else if (volumePercent >= 34 && volumePercent <= 67) {
            return <i className="nf nf-md-volume_medium"></i>;
          } else {
            return <i className="nf nf-md-volume_high"></i>;
          }
        }

        // Handle volume scroll changes
        function handleVolumeScroll(event) {
          event.preventDefault(); // Prevent page scroll
          
          if (!output.audio?.defaultPlaybackDevice) return;
          
          const currentVolume = output.audio.defaultPlaybackDevice.volume;
          const scrollDirection = event.deltaY > 0 ? -1 : 1; // Invert for natural scroll feel
          const volumeStep = 5; // Change volume by 5% per scroll
          
          let newVolume = currentVolume + (scrollDirection * volumeStep);
          newVolume = Math.max(0, Math.min(100, newVolume)); // Clamp between 0-100
          
          // Use the setVolume function from the audio provider
          output.audio.setVolume(newVolume);
        }

        // Toggle mute/unmute when clicking on volume widget
        function toggleMute() {
          if (!output.audio?.defaultPlaybackDevice) return;
          
          const device = output.audio.defaultPlaybackDevice;
          const currentVolume = device.volume;
          const isMuted = device.isMuted === true || 
                          device.muted === true || 
                          device.isSilenced === true ||
                          currentVolume === 0;
          
          if (isMuted) {
            output.audio.setVolume(previousVolume);
          } else {
            setPreviousVolume(currentVolume);
            output.audio.setVolume(0);
          }
        }

        function openSoundSettings(event) {
          event.preventDefault();
          
          window.open('ms-settings:sound', '_blank');
        }

        return (
          <div className="app">
            <div className="left">
              {output.cpu && (
                <div className="cpu">
                  <i className="nf nf-oct-cpu"></i>

                  {/* Change the text color if the CPU usage is high. */}
                  <span
                    className={output.cpu.usage > 90 ? 'high-usage' : ''}
                  >
                    {Math.round(output.cpu.usage)}%
                  </span>
                </div>
              )}
              
              {output.memory && (
                <div className="memory">
                  <i className="nf nf-fae-chip"></i>
                  
                  {/* Change the text color if the RAM usage is high. */}
                  <span
                    className={output.memory.usage > 90 ? 'high-usage' : ''}
                  >
                    {Math.round(output.memory.usage)}%
                  </span>
                </div>
              )}
                            
              {output.battery && (
                <div className="battery">
                  {output.battery.isCharging && (
                    <i className="nf nf-md-power_plug charging-icon"></i>
                  )}
                  {getBatteryIcon(output.battery)}
                  {Math.round(output.battery.chargePercent)}%
                </div>
              )}
              
              {output.audio && output.audio.defaultPlaybackDevice && (
                <div 
                  className="volume" 
                  onWheel={handleVolumeScroll}
                  onClick={toggleMute}
                  onContextMenu={openSoundSettings}
                  title="Left-click: mute/unmute • Scroll: adjust volume • Right-click: sound settings"
                  style={{ cursor: 'pointer' }}
                >
                  {getVolumeIcon(output.audio)}
                  {Math.round(output.audio.defaultPlaybackDevice.volume)}%
                </div>
              )}
              
              {output.media && output.media.currentSession && (
                <div className="media-section">
                  <div className="media-controls">
                    <button
                      className="media-button"
                      onClick={() => output.media.previous()}
                      title="Previous"
                    >
                      <i className="nf nf-md-skip_previous"></i>
                    </button>
                    <button
                      className="media-button play-pause"
                      onClick={() => output.media.togglePlayPause()}
                      title={output.media.currentSession.isPlaying ? 'Pause' : 'Play'}
                    >
                      <i className={`nf ${output.media.currentSession.isPlaying ? 'nf-md-pause' : 'nf-md-play'}`}></i>
                    </button>
                    <button
                      className="media-button"
                      onClick={() => output.media.next()}
                      title="Next"
                    >
                      <i className="nf nf-md-skip_next"></i>
                    </button>
                  </div>
                  
                  <div className="media-info">
                    <span className="media-title" ref={mediaTitleRef}>
                      {output.media.currentSession.artist && `${output.media.currentSession.artist} – `}
                      {output.media.currentSession.title}
                    </span>
                  </div>
                </div>
              )}
            </div>

            <div className="center">
              {output.glazewm && (
                <div className="workspaces">
                  {output.glazewm.currentWorkspaces.map(workspace => (
                    <button
                      className={`workspace ${workspace.hasFocus && 'focused'} ${workspace.isDisplayed && 'displayed'}`}
                      onClick={() =>
                        output.glazewm.runCommand(
                          `focus --workspace ${workspace.name}`,
                        )
                      }
                      key={workspace.name}
                    >
                      {workspace.displayName ?? workspace.name}
                    </button>
                  ))}
                </div>
              )}
            </div>

            <div className="right">
              {output.systray && (
                <div className="systray">
                  {output.systray.icons.map(icon => (
                    <img
                      key={icon.id}
                      src={icon.iconUrl}
                      alt={icon.tooltip}
                      title={icon.tooltip}
                      className="systray-icon"
                      onClick={(e) => {
                        e.preventDefault();
                        output.systray.onLeftClick(icon.id);
                      }}
                      onContextMenu={(e) => {
                        e.preventDefault();
                        output.systray.onRightClick(icon.id);
                      }}
                      onMouseEnter={() => {
                        output.systray.onHoverEnter(icon.id);
                      }}
                      onMouseLeave={() => {
                        output.systray.onHoverLeave(icon.id);
                      }}
                    />
                  ))}
                </div>
              )}

              {output.weather && (
                <div 
                  className={`weather ${isTransitioning ? 'transitioning' : ''}`}
                  title={`${output.weather.status?.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`}
                  onClick={toggleTemperatureUnit}
                >
                  {getWeatherIcon(output.weather)}
                  {getDisplayedTemperature(output.weather).temp}{getDisplayedTemperature(output.weather).unit}
                </div>
              )}

              {output.date && (
                <div className="date">
                  <i className="nf nf-fa-calendar"></i>
                  {output.date.formatted}
                </div>
              )}

              {output.time && (
                <div className="time">
                  <i className="nf nf-fa-clock"></i>
                  {output.time.formatted}
                </div>
              )}
            </div>
          </div>
        );
      }
    </script>
  </body>
</html>
